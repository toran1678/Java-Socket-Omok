package ChatApp.Client.PrivateChatRoom;

import ChatApp.Client.ClientApplication;
import Database.Database;
import Function.DTO.MessageDTO;
import Function.DTO.MessageType;
import Function.Image.ResizeImage;
import Function.SwingCompFunc.BubblePanel;
import Function.SwingCompFunc.SwingCompFunc;

import javax.swing.*;
import javax.swing.border.BevelBorder;
import javax.swing.text.BadLocationException;
import javax.swing.text.Style;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyledDocument;
import java.awt.*;
import java.awt.event.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Map;

public class PrivateChatRoom extends JFrame {
    ImageIcon gameIcon = new ImageIcon("src/Database/Image/ÏïÑÏù¥ÏΩò.jpg");
    private String nickname;
    private String roomName;
    private final ClientApplication client;
    private String oppo;
    JTextPane chatPane = new JTextPane();
    JPanel chatPanel = new JPanel();
    JScrollPane chatScrollPane = new JScrollPane(chatPanel);
    JTextField inputField;
    JButton sendButton = new JButton("Ï†ÑÏÜ°");
    JButton emojiButton = new JButton("„ã°");
    JButton paletteButton = new JButton("üé®");
    JButton fileSendButton = new JButton("üìé");
    JButton inviteButton = new JButton("Ï¥àÎåÄ");
    JLabel titleLabel = new JLabel();
    JPanel topPanel = new JPanel();
    ArrayList<String> loadMessages;

    int currentY = 10;

    public PrivateChatRoom(String user, String roomName, ClientApplication client, ArrayList<String> messages, String oppo) {
        this.nickname = user;
        this.roomName = roomName;
        this.client = client;
        this.loadMessages = messages;
        this.oppo = oppo;
        initUI();
    }

    public static void main(String[] args) {
        new PrivateChatRoom("toran", "test", new ClientApplication(), null, "oppo").setVisible(true);
    }

    public String getRoomName() { return this.roomName; }

    private void initUI() {
        setTitle("1ÎåÄ1 Ï±ÑÌåÖ");
        setSize(600, 600);
        setLayout(new BorderLayout());

        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLocationRelativeTo(null);
        setResizable(false);

        setIconImage(gameIcon.getImage());

        /* Ï±ÑÌåÖ Ìå®ÎÑê */
        chatPanel.setLayout(null);
        chatPanel.setPreferredSize(new Dimension(460, 460));
        chatPanel.setBackground(Color.WHITE);

        titleLabel.setText(roomName);
        // topPanel.setBorder(BorderFactory.createBevelBorder(BevelBorder.LOWERED));
        // topPanel.setBackground(new Color(153, 204, 255));

        SwingCompFunc.setTopPanelStyle(topPanel);
        titleLabel.setFont(new Font("ÎßëÏùÄ Í≥†Îîï", Font.BOLD, 16));
        titleLabel.setForeground(Color.WHITE);
        topPanel.setPreferredSize(new Dimension(0, 40));

        topPanel.add(titleLabel);

        chatPane.setEditable(false);
        chatPane.setFont(new Font("ÎßëÏùÄ Í≥†Îîï", Font.PLAIN, 14));

        chatScrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);

        // ÏûÖÎ†• Î∞è Ï†ÑÏÜ° Î≤ÑÌäº ÏÑ§Ï†ï
        inputField = new JTextField();
        inputField.setFont(new Font("ÎßëÏùÄ Í≥†Îîï", Font.PLAIN, 14));

        SwingCompFunc.setButtonStyle(sendButton);
        SwingCompFunc.setButtonStyle(emojiButton);
        SwingCompFunc.setButtonStyle(paletteButton);
        SwingCompFunc.setButtonStyle(fileSendButton);
        SwingCompFunc.setButtonStyle(inviteButton);

        // Ï†ÑÏÜ° Î≤ÑÌäº Î∞è ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        ActionListener sendMessageAction = new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                String message = inputField.getText().trim();
                if (!message.isEmpty()) {
                    client.sendMessage(new MessageDTO(MessageType.PrivateChat, roomName + ":" + nickname + ":" + message));
                    inputField.setText("");
                }
            }
        };
        inputField.addActionListener(sendMessageAction);
        sendButton.addActionListener(sendMessageAction);

        JPanel buttonPanel = new JPanel(); // Î≤ÑÌäºÏùÑ ÎÇòÎûÄÌûà Î∞∞ÏπòÌï† Ìå®ÎÑê ÏÉùÏÑ±
        buttonPanel.setLayout(new FlowLayout(FlowLayout.RIGHT)); // Î≤ÑÌäºÏùÑ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨

        buttonPanel.add(sendButton);
        buttonPanel.add(emojiButton);
        buttonPanel.add(paletteButton);
        buttonPanel.add(fileSendButton);
        buttonPanel.add(inviteButton);

        // ÌïòÎã® Ìå®ÎÑê ÏÑ§Ï†ï
        JPanel bottomPanel = new JPanel(new BorderLayout());
        bottomPanel.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));
        bottomPanel.add(inputField, BorderLayout.CENTER);
        bottomPanel.add(buttonPanel, BorderLayout.EAST);

        // ÌîÑÎ†àÏûÑÏóê Ïª¥Ìè¨ÎÑåÌä∏ Ï∂îÍ∞Ä
        add(topPanel, BorderLayout.NORTH);
        add(chatScrollPane, BorderLayout.CENTER);
        add(bottomPanel, BorderLayout.SOUTH);

        addWindowListener(new WindowAdapter() {
            @Override
            public void windowClosing(WindowEvent e) {
                handleWindowClosing();
            }
        });

        emojiButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                openEmojiSelector();
            }
        });

        paletteButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                openPaletteFrame();
            }
        });

        fileSendButton.addActionListener(e -> {
            JFileChooser fileChooser = new JFileChooser();
            int returnValue = fileChooser.showOpenDialog(this);
            if (returnValue == JFileChooser.APPROVE_OPTION) {
                File selectedFile = fileChooser.getSelectedFile();
                sendFile(selectedFile);
            }
        });

        inviteButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                client.sendMessage(new MessageDTO(
                        MessageType.InvitePrivateRoom, client.getNickName() + ":" + oppo
                ));
            }
        });

        loadMessage();
    }

    private void loadMessage() {
        if (loadMessages.isEmpty()) {
            System.out.println("Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå");
        } else {
            // content[0]: nickName, content[1]: message, content[2]: time
            for (String message : loadMessages) {
                String[] content = message.split(":", 3);
                if (!content[0].contains("ÏÑúÎ≤Ñ")) {
                    SwingUtilities.invokeLater(() -> {
                        if (content[1].startsWith("[EmojiCode]-")) {
                            String[] parts = content[1].split("-");
                            int emojiNumber = Integer.parseInt(parts[1]);
                            appendEmoji(emojiNumber, content[0], content[2]);
                        } else {
                            displayMessage(content[0] + ": " + content[1], content[2]);
                        }
                    });
                }
            }
        }
    }

    private void sendFile(File file) {
        try {
            String roomName = getRoomName();
            String fileName = file.getName();
            long fileSize = file.length();

            client.sendMessage(new MessageDTO(
                    MessageType.FileTransferRequest,
                    roomName + ":" + nickname + ":" + file.getName() + ":" + file.length()
            ));

            // ÌååÏùº Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
            FileInputStream fis = new FileInputStream(file);
            byte[] buffer = new byte[4096];
            int bytesRead;
            while ((bytesRead = fis.read(buffer)) != -1) {
                client.sendFileData(buffer, bytesRead);
            }
            fis.close();

            JOptionPane.showMessageDialog(this, "ÌååÏùº Ï†ÑÏÜ° ÏôÑÎ£å: " + fileName);
        } catch (IOException e) {
            JOptionPane.showMessageDialog(this, "ÌååÏùº Ï†ÑÏÜ° Ïã§Ìå®: " + e.getMessage());
        }
    }

    private void handleWindowClosing() {
        // client.sendMessage(new MessageDTO(MessageType.PrivateChat, roomName + ":" + "ÏÑúÎ≤Ñ" + ":" + nickname + " ÎãòÏù¥ Ï¢ÖÎ£åÌïòÏÖ®ÏäµÎãàÎã§."));
        chatPane.setText("");
        System.out.println("1ÎåÄ1 Ï±ÑÌåÖ Ï¢ÖÎ£å - " + roomName);
        dispose();
    }

    public void displayMessage(String message) {
        boolean isMine = message.split(":")[0].startsWith("[" + nickname + "]");

        String time = getCurrentTime();

        // ÎßêÌíçÏÑ† Ìå®ÎÑê ÏÉùÏÑ±
        BubblePanel bubble = new BubblePanel(message, time, isMine);

        // ÎßêÌíçÏÑ† ÏúÑÏπò Í≥ÑÏÇ∞ Î∞è Ï∂îÍ∞Ä
        int panelWidth = chatPanel.getWidth();
        int bubbleWidth = bubble.getPreferredSize().width;
        int x = isMine ? panelWidth - bubbleWidth - 20 : 20; // Ïò§Î•∏Ï™Ω ÎòêÎäî ÏôºÏ™Ω Ï†ïÎ†¨

        bubble.setBounds(x, currentY, bubbleWidth, bubble.getPreferredSize().height);
        chatPanel.add(bubble);

        // Y Ï¢åÌëú Í∞±Ïã†
        currentY += bubble.getPreferredSize().height + 10;

        // Ï±ÑÌåÖ Ìå®ÎÑê ÌÅ¨Í∏∞ Í∞±Ïã†
        chatPanel.setPreferredSize(new Dimension(chatPanel.getWidth(), currentY));
        chatPanel.revalidate();
        chatPanel.repaint();

        // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }

    public void displayMessage(String message, String time) {
        boolean isMine = message.split(":")[0].startsWith("[" + nickname + "]");

        // ÎßêÌíçÏÑ† Ìå®ÎÑê ÏÉùÏÑ±
        BubblePanel bubble = new BubblePanel(message, time, isMine);

        // ÎßêÌíçÏÑ† ÏúÑÏπò Í≥ÑÏÇ∞ Î∞è Ï∂îÍ∞Ä
        int panelWidth = chatPanel.getWidth();
        int bubbleWidth = bubble.getPreferredSize().width;
        int x = isMine ? panelWidth - bubbleWidth - 20 : 20; // Ïò§Î•∏Ï™Ω ÎòêÎäî ÏôºÏ™Ω Ï†ïÎ†¨

        bubble.setBounds(x, currentY, bubbleWidth, bubble.getPreferredSize().height);
        chatPanel.add(bubble);

        // Y Ï¢åÌëú Í∞±Ïã†
        currentY += bubble.getPreferredSize().height + 10;

        // Ï±ÑÌåÖ Ìå®ÎÑê ÌÅ¨Í∏∞ Í∞±Ïã†
        chatPanel.setPreferredSize(new Dimension(chatPanel.getWidth(), currentY));
        chatPanel.revalidate();
        chatPanel.repaint();

        // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }

    public void appendEmoji(int emojiIndex, String sender, String time) {
        boolean isMine = sender.equals(nickname);

        // Ïù¥Î™®Ìã∞ÏΩò Í≤ΩÎ°ú
        String emojiPath = "src/Function/EMOJI/" + emojiIndex + ".jpg";
        ImageIcon emojiIcon = ResizeImage.resizeImage(emojiPath, 48, 48); // Ïù¥Î™®Ìã∞ÏΩò ÌÅ¨Í∏∞ Ï°∞Ï†ï

        // ÎßêÌíçÏÑ† Ìå®ÎÑê ÏÉùÏÑ±
        BubblePanel bubble = new BubblePanel(emojiIcon, time, isMine);

        // ÎßêÌíçÏÑ† ÏúÑÏπò Í≥ÑÏÇ∞ Î∞è Ï∂îÍ∞Ä
        int panelWidth = chatPanel.getWidth();
        int bubbleWidth = bubble.getPreferredSize().width;
        int x = isMine ? panelWidth - bubbleWidth - 20 : 20; // Ïò§Î•∏Ï™Ω ÎòêÎäî ÏôºÏ™Ω Ï†ïÎ†¨

        bubble.setBounds(x, currentY, bubbleWidth, bubble.getPreferredSize().height);
        chatPanel.add(bubble);

        // Y Ï¢åÌëú Í∞±Ïã†
        currentY += bubble.getPreferredSize().height + 10;

        // Panel Î∞è Scroll ÏóÖÎç∞Ïù¥Ìä∏
        chatPanel.setPreferredSize(new Dimension(chatPanel.getWidth(), currentY));
        chatPanel.revalidate();
        chatPanel.repaint();

        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }

    public void addFileMessage(String sender, String fileName, long fileSize) {
        boolean isMine = sender.equals(nickname);
        String time = getCurrentTime();

        // ÌååÏùº ÎßêÌíçÏÑ† ÏÉùÏÑ±
        BubblePanel bubble = new BubblePanel(
                sender + "ÎãòÏù¥ ÌååÏùºÏùÑ Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§: " + fileName + " (" + fileSize / 1024 + " KB)",
                time,
                isMine,
                true,
                client
        );

        // ÌÅ¥Î¶≠ Ïãú ÌååÏùº Îã§Ïö¥Î°úÎìú Î°úÏßÅ Ïã§Ìñâ
        bubble.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                downloadFile(fileName);
            }
        });

        bubble.setBackground(SwingCompFunc.LoginButtonColor);

        // ÎßêÌíçÏÑ† ÏúÑÏπò Í≥ÑÏÇ∞ Î∞è Ï∂îÍ∞Ä
        int panelWidth = chatPanel.getWidth();
        int bubbleWidth = bubble.getPreferredSize().width;
        int x = isMine ? panelWidth - bubbleWidth - 20 : 20;

        bubble.setBounds(x, currentY, bubbleWidth, bubble.getPreferredSize().height);
        chatPanel.add(bubble);

        // Y Ï¢åÌëú Í∞±Ïã†
        currentY += bubble.getPreferredSize().height + 10;

        // Ìå®ÎÑê Î∞è Ïä§ÌÅ¨Î°§ Í∞±Ïã†
        chatPanel.setPreferredSize(new Dimension(chatPanel.getWidth(), currentY));
        chatPanel.revalidate();
        chatPanel.repaint();

        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }

    private void downloadFile(String fileName) {
        if (fileName == null || fileName.isEmpty()) {
            JOptionPane.showMessageDialog(this, "ÌååÏùº Ïù¥Î¶ÑÏù¥ ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§.");
            return;
        }

        if (client == null || client.socket == null || client.socket.isClosed()) {
            JOptionPane.showMessageDialog(this, "ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.");
            return;
        }

        client.sendMessage(new MessageDTO(MessageType.FileDownloadRequest, fileName));
    }

    /* ÌòÑÏû¨ ÏãúÍ∞Ñ Í∞ÄÏ†∏Ïò§Í∏∞ */
    public String getCurrentTime() {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("HH:mm:ss");
        return LocalDateTime.now().format(formatter);
    }

    public void displayMessage2(String message) {
        // chatArea.append(message + "\n");
        boolean isMine = message.startsWith("["+ nickname +"]");
        Style style = chatPane.addStyle("ChatStyle", null);
        StyledDocument doc = chatPane.getStyledDocument();
        setStyleIsMine(style, isMine);

        if (isMine) {
            message = message.split(":")[1] + "< [ÎÇò]";
        }
        try {
            doc.insertString(doc.getLength(), message + "\n", style);
            doc.setParagraphAttributes(doc.getLength() - 1, 1, style, false);
        } catch (BadLocationException e) {
            System.err.println(e.getMessage());
        }


        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }

    /* Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° */
    public void openEmojiSelector() {
        JFrame emojiFrame = new JFrame("Ïù¥Î™®Ìã∞ÏΩò ÏÑ†ÌÉù");
        emojiFrame.setSize(400, 300);
        emojiFrame.setLayout(new GridLayout(2, 3));
        emojiFrame.setLocationRelativeTo(this);

        SwingCompFunc.setFrameStyle(emojiFrame);

        // Ïù¥Î™®Ìã∞ÏΩò Î≤àÌò∏ÏôÄ Ïù¥ÎØ∏ÏßÄÎ•º Îß§Ìïë
        Map<Integer, String> emojiMap = Map.of(
                1, "src/Function/EMOJI/1.jpg",
                2, "src/Function/EMOJI/2.jpg",
                3, "src/Function/EMOJI/3.jpg",
                4, "src/Function/EMOJI/4.jpg",
                5, "src/Function/EMOJI/5.jpg",
                6, "src/Function/EMOJI/6.jpg"
        );

        // Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº ÏÉùÏÑ±
        for (Map.Entry<Integer, String> entry : emojiMap.entrySet()) {
            int emojiNumber = entry.getKey();
            String imagePath = entry.getValue();

            ImageIcon imageIcon = ResizeImage.resizeImage(imagePath, 128, 128);

            JButton emojiButton = new JButton(imageIcon);
            emojiButton.addActionListener(e -> {
                // ÏÑ†ÌÉùÎêú Ïù¥ÎØ∏ÏßÄ Î≤àÌò∏ Ï†ÑÏÜ°
                sendEmoji(emojiNumber);

                // ÌîÑÎ†àÏûÑ Îã´Í∏∞
                emojiFrame.dispose();
            });
            emojiFrame.add(emojiButton);
        }

        emojiFrame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        emojiFrame.setVisible(true);
    }

    private void sendEmoji(int emojiNumber) {
        // client.sendMessage(new MessageDTO(MessageType.EMOJI, nickname + ":" + emojiNumber));
        client.sendMessage(new MessageDTO(MessageType.PrivateChat, roomName + ":" + nickname + "::" + emojiNumber));
    }

    public void appendEmoji(int emojiIndex, String sender) {
        boolean isMine = sender.equals(nickname);
        String time = LocalDateTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss"));

        // Ïù¥Î™®Ìã∞ÏΩò Í≤ΩÎ°ú
        String emojiPath = "src/Function/EMOJI/" + emojiIndex + ".jpg";
        ImageIcon emojiIcon = ResizeImage.resizeImage(emojiPath, 48, 48); // Ïù¥Î™®Ìã∞ÏΩò ÌÅ¨Í∏∞ Ï°∞Ï†ï

        // ÎßêÌíçÏÑ† Ìå®ÎÑê ÏÉùÏÑ±
        BubblePanel bubble = new BubblePanel(emojiIcon, time, isMine);

        // ÎßêÌíçÏÑ† ÏúÑÏπò Í≥ÑÏÇ∞ Î∞è Ï∂îÍ∞Ä
        int panelWidth = chatPanel.getWidth();
        int bubbleWidth = bubble.getPreferredSize().width;
        int x = isMine ? panelWidth - bubbleWidth - 20 : 20; // Ïò§Î•∏Ï™Ω ÎòêÎäî ÏôºÏ™Ω Ï†ïÎ†¨

        bubble.setBounds(x, currentY, bubbleWidth, bubble.getPreferredSize().height);
        chatPanel.add(bubble);

        // Y Ï¢åÌëú Í∞±Ïã†
        currentY += bubble.getPreferredSize().height + 10;

        // Panel Î∞è Scroll ÏóÖÎç∞Ïù¥Ìä∏
        chatPanel.setPreferredSize(new Dimension(chatPanel.getWidth(), currentY));
        chatPanel.revalidate();
        chatPanel.repaint();

        SwingUtilities.invokeLater(() -> {
            JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
            vertical.setValue(vertical.getMaximum());
        });
    }


    public void setStyleIsMine(Style style, boolean isMine) {
        if (isMine) {
            // ÎÇ¥ Î©îÏãúÏßÄ: Ïò§Î•∏Ï™Ω Ï†ïÎ†¨
            StyleConstants.setAlignment(style, StyleConstants.ALIGN_RIGHT);
            StyleConstants.setForeground(style, new Color(76, 175, 80)); // Ï¥àÎ°ùÏÉâ
        } else {
            // ÏÉÅÎåÄ Î©îÏãúÏßÄ: ÏôºÏ™Ω Ï†ïÎ†¨
            StyleConstants.setAlignment(style, StyleConstants.ALIGN_LEFT);
            StyleConstants.setForeground(style, new Color(33, 150, 243)); // ÌååÎûÄÏÉâ
        }
    }

    private void openPaletteFrame() {
        JFrame paletteFrame = new JFrame("ÏÉâÏÉÅ ÏÑ§Ï†ï");
        paletteFrame.setSize(400, 350); // ÏÉÅÎã® Ìå®ÎÑê Í≥µÍ∞ÑÏùÑ Í≥†Î†§Ìï¥ ÎÜíÏù¥ Ï¶ùÍ∞Ä
        paletteFrame.setLayout(new BorderLayout(10, 10));
        paletteFrame.setLocationRelativeTo(this);

        SwingCompFunc.setFrameStyle(paletteFrame);

        // ÏÉÅÎã® Ìå®ÎÑê ÏÉùÏÑ±
        JPanel titlePanel = new JPanel(new BorderLayout());
        JLabel titleLabel = new JLabel("ÏÉâÏÉÅ ÏÑ†ÌÉù", SwingConstants.CENTER);
        titleLabel.setFont(new Font("ÎßëÏùÄ Í≥†Îîï", Font.BOLD, 18));
        titleLabel.setForeground(Color.WHITE);
        SwingCompFunc.setTopPanelStyle(titlePanel);
        titlePanel.setPreferredSize(new Dimension(paletteFrame.getWidth(), 50));
        titlePanel.add(titleLabel, BorderLayout.CENTER);

        // ÏÉâÏÉÅ ÏÑ†ÌÉù Î≤ÑÌäº ÏÉùÏÑ±
        JButton backgroundColorButton = new JButton("Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω");
        JButton myBubbleColorButton = new JButton("ÎÇ¥ ÏÉâÏÉÅ Î≥ÄÍ≤Ω");
        JButton otherBubbleColorButton = new JButton("ÏÉÅÎåÄ ÏÉâÏÉÅ Î≥ÄÍ≤Ω");

        backgroundColorButton.setFont(new Font("ÎÇòÎàî Í≥†Îîï", Font.PLAIN, 12));
        myBubbleColorButton.setFont(new Font("ÎÇòÎàî Í≥†Îîï", Font.PLAIN, 12));
        otherBubbleColorButton.setFont(new Font("ÎÇòÎàî Í≥†Îîï", Font.PLAIN, 12));

        SwingCompFunc.setButtonStyle(backgroundColorButton);
        SwingCompFunc.setButtonStyle(myBubbleColorButton);
        SwingCompFunc.setButtonStyle(otherBubbleColorButton);

        // ÌîÑÎ¶¨Î∑∞ Ìå®ÎÑê ÏÉùÏÑ±
        JPanel backgroundPreview = new JPanel();
        backgroundPreview.setBackground(chatPanel.getBackground());
        backgroundPreview.setBorder(BorderFactory.createLineBorder(Color.GRAY));

        JPanel myBubblePreview = new JPanel();
        myBubblePreview.setBackground(BubblePanel.getMyBubbleColor());
        myBubblePreview.setBorder(BorderFactory.createLineBorder(Color.GRAY));

        JPanel otherBubblePreview = new JPanel();
        otherBubblePreview.setBackground(BubblePanel.getOtherBubbleColor());
        otherBubblePreview.setBorder(BorderFactory.createLineBorder(Color.GRAY));

        // ÏÉâÏÉÅ ÏÑ†ÌÉù Î≤ÑÌäº ÎèôÏûë
        backgroundColorButton.addActionListener(e -> {
            Color selectedColor = JColorChooser.showDialog(paletteFrame, "Î∞∞Í≤ΩÏÉâ ÏÑ†ÌÉù", chatPanel.getBackground());
            if (selectedColor != null) {
                chatPanel.setBackground(selectedColor);
                backgroundPreview.setBackground(selectedColor);
            }
        });

        myBubbleColorButton.addActionListener(e -> {
            Color selectedColor = JColorChooser.showDialog(paletteFrame, "ÎÇ¥ Ï±ÑÌåÖÏÉâ ÏÑ†ÌÉù", BubblePanel.getMyBubbleColor());
            if (selectedColor != null) {
                BubblePanel.setMyBubbleColor(selectedColor);
                myBubblePreview.setBackground(selectedColor);
            }
        });

        otherBubbleColorButton.addActionListener(e -> {
            Color selectedColor = JColorChooser.showDialog(paletteFrame, "ÏÉÅÎåÄ Ï±ÑÌåÖÏÉâ ÏÑ†ÌÉù", BubblePanel.getOtherBubbleColor());
            if (selectedColor != null) {
                BubblePanel.setOtherBubbleColor(selectedColor);
                otherBubblePreview.setBackground(selectedColor);
            }
        });

        // Î©îÏù∏ Ìå®ÎÑê ÏÉùÏÑ±
        JPanel mainPanel = new JPanel(new GridLayout(3, 3, 10, 10));
        mainPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        mainPanel.add(new JLabel("Î∞∞Í≤ΩÏÉâ", SwingConstants.CENTER));
        mainPanel.add(backgroundPreview);
        mainPanel.add(backgroundColorButton);

        mainPanel.add(new JLabel("ÎÇ¥ Ï±ÑÌåÖÏÉâ", SwingConstants.CENTER));
        mainPanel.add(myBubblePreview);
        mainPanel.add(myBubbleColorButton);

        mainPanel.add(new JLabel("ÏÉÅÎåÄ Ï±ÑÌåÖÏÉâ", SwingConstants.CENTER));
        mainPanel.add(otherBubblePreview);
        mainPanel.add(otherBubbleColorButton);

        // ÌîÑÎ†àÏûÑÏóê Ïª¥Ìè¨ÎÑåÌä∏ Ï∂îÍ∞Ä
        paletteFrame.add(titlePanel, BorderLayout.NORTH); // ÏÉÅÎã® Ìå®ÎÑê
        paletteFrame.add(mainPanel, BorderLayout.CENTER); // Î©îÏù∏ Ìå®ÎÑê

        paletteFrame.setVisible(true);
    }
}

